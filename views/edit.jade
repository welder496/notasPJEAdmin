extends layout

block css
   link(rel='stylesheet', href='/stylesheets/tokenfield/css/bootstrap-tokenfield.css')
   link(rel='stylesheet', href='/stylesheets/jquery-ui/jquery-ui.css')
   link(rel='stylesheet', href='/stylesheets/editors5/dist/bootstrap3-wysihtml5.css')
   link(rel='stylesheet', href='/stylesheets/editors5/dist/bootstrap3-wysihtml5-editor.css')
   script(src='/stylesheets/datatables/media/js/jquery.js')
   script.
      if (#{show}) {
         $(document).on('ready', function(){
            $('#modalEdit').modal({backdrop: 'static', show: true});
         });
      }

block content
   form.form-horizontal(role="form" method="post" enctype="multipart/form-data")
      div.form-group
         label.control-label.col-sm-2(for="codigo") Código:
         div.col-sm-3
            input#editCodigo.form-control(type="text" readonly placeholder="Insira um número" name="codigo" value="#{codigo}")

      div.form-group
         label.control-label.col-sm-2(for="nota") Nota:
         div.col-sm-10
            textarea#editNota.form-control(rows="20" name="nota" placeholder="Escreva uma nota ou descrição aqui!!") #{nota}

      #listaArquivos.form-group
         label.control-label.col-sm-2(for='arquivos') Arquivo(s) cadastrado(s):
         #itensArquivos.col-sm-10
            if (arquivos != '')
               for arquivo, i in arquivos
                  div(id=i)
                     a(id=i value="#{arquivo}") #{arquivo}
                     span &nbsp&nbsp
                     button.btn.btn-default.btn-xs(id=i value="#{arquivo}") -

      div.form-group
         label.control-label.col-sm-2(for='arquivos') Arquivo(s):
         div.col-sm-4
            input#editArquivos.form-control(type="file" name="file" accept="image/*,audio/*,video/*,.pdf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" placeholder="Insira um arquivo aqui!!" multiple)

      div.form-group
         label.control-label.col-sm-2(for="Issue") Número da Issue:
         div.col-sm-4
            input#editIssue.form-control(type="text" name="issue" maxlength="20" placeholder="Insira o número de uma Issue!!")

      div.form-group
          label.control-label.col-sm-2(for="Perfil") Perfil:
          div.col-sm-10
             select#perfil.form-control.input-lg(multiple size="5")
               if (perfils != "")
                  for perfil in perfils
                     option(id="#{perfil._id}") #{perfil.descricao}

      div.form-group
          label.control-label.col-sm-2(for="Funcionalidade") Funcionalidade:
          div.col-sm-5
             select#funcionalidade.form-control.input-lg(multiple size="5")
               if (funcionalidades != "")
                  for funcionalidade in funcionalidades
                     option #{funcionalidade.descricao}
          div.col-sm-5
             select#subTipos.form-control.input-lg(multiple size="5")
               if (subTipos != "")
                  for subTipo in subTipos
                     option #{subTipo}

      div.form-group
         label.control-label.col-sm-2(for="tags") Tags:
         div.col-sm-10
            input#editTags.form-control(type="text" name="tags" placeholder="Insira tags aqui!!" value="#{tags}")

      #modalEdit.modal
         .modal-dialog
            .modal-content
               .modal-header
                  button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
                  h4.modal-title Mensagem:
               .modal-body
                  p #{message}
               .modal-footer
                  button.btn.btn-default(type="button" data-dismiss="modal") Fechar

      div.form-group
         div.col-sm-offset-2.col-sm-2
            button#editEnviar.btn.btn-default Salvar
               input#comando.form-control(type="hidden" name="comando" value="post")
               input#versao.form-control(type="hidden" name="versao" value="#{versao}")

block script
   script(src='/stylesheets/tokenfield/bootstrap-tokenfield.js')
   script(src='/javascripts/componentsInit/tokenfields.js')
   script(src='/stylesheets/editors5/dist/wysihtml5x-toolbar.min.js')
   script(src='/stylesheets/editors5/dist/bootstrap3-wysihtml5.js')
   script(src='/javascripts/componentsInit/textAreaEditor.js')
   script.
      $('#editTags').on('tokenfield:createtoken', function(event){
             var existingTokens = $(this).tokenfield('getTokens');
             $.each(existingTokens, function(index, token){
                   if (token.value === event.attrs.value) {
                          event.preventDefault();
                   }
             });
      });

      $('#itensArquivos button.btn.btn-default.btn-xs').on('click',function(event){
         var i = $(this).attr('id');
         var value = $(this).attr('value');
         $('div #'+i).remove();
         var count = $('#itensArquivos').children().length;
         if (count == 0)
                   $('#listaArquivos').attr('style','display: none');
         rest.del('/documents',{codigo:"#{codigo}",value: value});
         rest.get('/version',{codigo:"#{codigo}"}, function(data){
                   $('#versao.form-control').val(data.versao);
         });
         $('#comando.form-control').val('edit');
      });

      $('select#perfil').on('click',function(event){
             $('#editTags').tokenfield('createToken','Perfil: '+$('select#perfil option:selected').text());
      });

      $('select#perfil').on('keypress',function(event){
             var key = event.which || event.keyCode;
             if (event.keyCode == 13) {
                    $('#editTags').tokenfield('createToken','Perfil: '+$('select#perfil option:selected').text());
             }
             event.preventDefault();
      });

      $('select#funcionalidade').on('click',function(event){
             var descricao = $('select#funcionalidade option:selected').text();
             rest.get('/edit/funcionalidade/'+descricao, function(data){
                   $('select#subTipos').empty();
                   $.each(data, function(i, value){
                          $('select#subTipos').append($('<option>').text(value).attr('value', value));
                   });
             });
             event.preventDefault();
      });

      $('select#funcionalidade').on('keydown',function(event){
             var descricao = $('select#funcionalidade option:selected').text();
             rest.get('/edit/funcionalidade/'+descricao, function(data){
                   $('select#subTipos').empty();
                   $.each(data, function(i, value){
                          $('select#subTipos').append($('<option>').text(value).attr('value', value));
                   });
             });
      });

      $('select#funcionalidade').on('keypress',function(event){
             var descricao = $('select#funcionalidade option:selected').text();
             rest.get('/edit/funcionalidade/'+descricao, function(data){
                   $('select#subTipos').empty();
                   $.each(data, function(i, value){
                          $('select#subTipos').append($('<option>').text(value).attr('value', value));
                   });
             });
             event.preventDefault();
      });

      $('select#subTipos').on('click',function(event){
             var funcionalidade = $('select#funcionalidade option:selected').text();
             var subTipo = $('select#subTipos option:selected').text();
             if ((funcionalidade != "") && (subTipo != "")) {
                    $('#editTags').tokenfield('createToken','Funcionalidade: '+funcionalidade+'>>'+subTipo);
             }
             event.preventDefault();
      });

      $('select#subTipos').on('keypress',function(event){
             var key = event.which || event.keyCode;
             if (key == 13) {
                   var funcionalidade = $('select#funcionalidade option:selected').text();
                   var subTipo = $('select#subTipos option:selected').text();
                   if ((funcionalidade != "") && (subTipo != "")) {
                         $('#editTags').tokenfield('createToken','Funcionalidade: '+funcionalidade+'>>'+subTipo);
                   }
             }
             event.preventDefault();
      });

      $(document).on('click','a',function(event){
         var value = $(this).attr('value');
         rest.post('/documents',{codigo: "#{codigo}", value: value},function(data){
               window.open(data,'_blank','top=200,left=200,toolbar=no,resizable=yes,scrollbars=no,width=800,height=600');
         });
      });

      $(document).on('ready', function(){
         var count = $('#itensArquivos').children().length;
         if (count == 0)
            $('#listaArquivos').attr('style','display: none');
         else
            $('#listaArquivos').attr('style','display: block');
      });

      $('#editIssue').on('keyup',function(event){
             var numero = $(this).val().replace(/[^\d]/g,'');
             $('#editIssue').val(numero);
      });

      $('#editIssue').on('blur', function(event){
             var numero = $('#editIssue').val();
             if (numero != ""){
                   $('#editTags').tokenfield('createToken', 'Issue: '+numero);
             }
      });


